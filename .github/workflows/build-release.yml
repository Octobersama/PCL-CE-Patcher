name: Build and Release

on:
  # 1. 允许手动点击按钮触发
  workflow_dispatch:
  # 2. 每次推送到 master 分支时触发 (编译 + 生成Artifacts，但不发Release)
  push:
    branches: [ "master" ]
    tags: [ "v*" ] # 3. 打标签时触发 (编译 + 生成Artifacts + 发Release)

jobs:
  build:
    runs-on: windows-latest
    
    permissions:
      contents: write 

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore PCL_CE_Patcher.csproj

    # 编译生成 EXE
    - name: Build
      run: dotnet publish PCL_CE_Patcher.csproj -c Release -r win-x64 -p:PublishSingleFile=true --self-contained false -o ./output

    # 【修改点 1】：移除了 if 条件
    # 现在无论是什么触发方式，都会执行打包操作，为了下一步上传做准备
    - name: Package
      run: |
        copy LICENSE ./output/
        copy ThirdPartyNotices.txt ./output/
        powershell Compress-Archive -Path ./output/* -DestinationPath PCL_CE_Patcher.zip

    # 【修改点 2】：新增上传 Artifact 步骤
    # 每次构建成功后，都会把 zip 上传到 Action 的 Summary 页面供你下载测试
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PCL_CE_Patcher_Build # Action 页面上显示的附件名称
        path: PCL_CE_Patcher.zip   # 要上传的文件
        retention-days: 90         # 文件保留天数

    # 【修改点 3】：Release 步骤保持不变
    # 只有当这是 Tag 触发时，才把上面打好的包发布到 Releases 页面
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: PCL_CE_Patcher.zip